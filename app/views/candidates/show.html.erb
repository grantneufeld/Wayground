<%
require 'contact_presenter'
require 'external_link_presenter'

candidate ||= @candidate
contacts ||= @contacts
external_links ||= @external_links
ballot ||= @ballot || candidate.ballot
election ||= @election || ballot.election
office ||= @office || ballot.office
level ||= @level || election.level
person ||= @person || candidate.person
user ||= @user
party ||= @party || candidate.party
has_parties ||= level.parties.count > 0


content_for(:head) do
  %><link rel="profile" href="http://microformats.org/profile/hcard" />
<%
end

%><%= render 'ballots/breadcrumb', { ballot: ballot } %>
<h1><%= candidate.name %></h1>
<%
if party
  %><p class="party-label" style="border-color:<%= party.colour %>"><%= link_to party.name, [party.level, party] %> c<%
else
  %><p>C<%
end
%>andidate for <%= link_to office.name, [level, election, ballot] %><%
if candidate.is_rumoured
  %> <span class="rumoured">(unconfirmed)</span><%
end %>.
<br />in <%= link_to election.name, [level, election] %> (<%= link_to level.name, level %>).</p>
<%

dates = []
dates << "Candidacy announced on #{candidate.announced_on.to_datetime.to_s(:simple_date)}." if candidate.announced_on?
dates << "Withdrew from election on #{candidate.quit_on.to_datetime.to_s(:simple_date)}." if candidate.quit_on
if dates.size > 0
  %><p><%= safe_join(dates, "\n<br />".html_safe) %></p>
<%
end

vote_count = candidate.vote_count
if vote_count > 0
  %><p>Received <%= vote_count %> votes.</p>
<%
end

if contacts.count > 0
  %><h2>Contacts</h2>
<%
  contacts.each do |contact|
    presenter = ContactPresenter.new(view: self, contact: contact, user: user)
    %><p class="vcard"><%= presenter.present_attributes("<br />".html_safe) %></p>
<%  if user
      %><p><%= presenter.present_actions %></p>
<%  end
  end
end

if external_links.count > 0
  %><h2>Links</h2>
<ul class="link-list">
<%
  external_links.each do |link|
    presenter = ExternalLinkPresenter.new(view: self, link: link, user: user)
    %><%= presenter.present_link_in(:li) %>
<%
  end
  %></ul>
<%
end

if user.present?
  if candidate.has_authority_for_user_to?(user, :can_update)
    add_submenu_item(title: "Edit",
      path: edit_level_election_ballot_candidate_path(level, election, ballot, candidate)
    )
  end
  if candidate.has_authority_for_user_to?(user, :can_delete)
    add_submenu_item(title: 'Delete', path: [:delete, level, election, ballot, candidate],
      attrs: { data: { confirm: 'Are you sure?' }, method: :delete }
    )
  end
  if candidate.has_authority_for_user_to?(@user, :can_create)
    add_submenu_item(title: 'Add Contact',
      path: new_level_election_ballot_candidate_contact_path(level, election, ballot, candidate)
    )
  end
  if candidate.has_authority_for_user_to?(@user, :can_create)
    add_submenu_item(title: 'Add Link',
      path: new_level_election_ballot_candidate_external_link_path(level, election, ballot, candidate)
    )
  end
end -%>

<%
bio = person.bio
if bio.present?
  %><h2>Biography</h2>
<p class="fineprint">(The following text was provided by the candidate or campaign.)</p>
<blockquote><%= simple_text_to_html bio %></blockquote>
<%
end

candidates = ballot.candidates.running
if candidates.count > 1
-%>
</section>

<section class="contentchunk">
<h2>Other candidates for <%= ballot.descriptor %>:</h2>
<ul>
<%
  candidates.each do |other_candidate|
    unless other_candidate == candidate
      if has_parties
        other_party = other_candidate.party
        party_colour = other_party ? other_party.colour : nil
        %><li class="party-label" style="border-color:<%= party_colour %>"><%
      else
        other_party = nil
        %><li><%
      end
      %><%= link_to other_candidate.name, [level, election, ballot, other_candidate] %><%
      if has_parties
        if other_party
          %> (<%= content_tag(:abbr, title: other_party.name) { other_party.abbrev } %>)<%
        else
          %> (independent)<%
        end
      end
      %></li><%
    end
  end
-%>
</ul>
<%
end
-%>
