<%
# EXPECTS:
# events: an array (or ActiveRecord equivalent) of Event objects.
# user: the current user, if any

date_idx = nil
events.each do |event|
  event_start = event.start_at
  event_end = event.end_at
  event_date = event_start.to_date
  if date_idx != event_date
    date_idx = event_date
    %><h3><%= event_start.to_s(:plain_date) %></h3>
<%
  end
  %><div class="vevent">
<h4><%
  if event.is_cancelled
    %><span class="status" title="CANCELLED">Cancelled:</span>
<%
  end
  %><time class="dtstart" datetime="<%= event_start.to_s(:microformat) %>"><%= event_start.to_s(:plain_time).strip %></time><%
  unless event_end.blank?
    %>â€”<time class="dtend" datetime="<%= event_end.to_s(:microformat) %>"><%= event_end.to_s(:plain_time).strip %></time><%
  end %>:
<span class="summary"><%= link_to event.title, event %></span></h4>
<%
  event_location = event.location
  event_address = event.address -%>
<p><%
  unless event_location.blank? && event_address.blank?
    %><span class="location"><%
    unless event_location.blank?
      %><span class="fn org"><%= event.location %></span>
<%  end
    unless event_address.blank?
      %>(<span class="adr"><span class="street-address"><%= event_address %></span></span>)<%
    end
    %></span>
<br /><%
  end
  if event.description?
    %><span class="description"><%= simple_text_to_html_breaks(event.description) %></span>
<%
  end
  event_organizer = event.organizer
  if event_organizer.present?
    %><br />Presented by <%
    event_organizer_url = event.organizer_url
    if event_organizer_url.present?
      %><a href="<%= event_organizer_url %>" class="organizer"><%= event_organizer %></a><%
    else
      %><span class="organizer"><%= event_organizer %></span><%
    end
    %>.<%
  end %>
<%
  if event.has_authority_for_user_to?(user, :can_update)
    %><br /><%= link_to 'Edit', edit_event_path(event), :class => 'action' %>
<%  if event.has_authority_for_user_to?(user, :can_delete)
      %><%= link_to 'Delete', delete_event_path(event), :confirm => 'Are you sure?', :method => :delete, :class => 'action' %>
<%  end
  end
  %></p>
</div>
<% end -%>
