# encoding: utf-8 <%
%>BEGIN:VEVENT<%= "\r\n"
%>UID:<%= event.id %>-event@wayground.ca<%= "\r\n"
%>CREATED<%= event.created_at.icalendar_with_zone %><%= "\r\n"
%>DTSTAMP<%= event.updated_at.icalendar_with_zone %><%= "\r\n"
%>DTSTART<%= event.start_at.icalendar_with_zone %><%= "\r\n"
%><% if event.end_at?
  %>DTEND<%= event.end_at.icalendar_with_zone %><%= "\r\n"
%><% end
%>SUMMARY:<%= event.title.gsub(/(\r\n?|\n)/, "\\r\\n").fold!(75,8) %><%= "\r\n"
%><% if event.description?
  %>DESCRIPTION:<%= event.description.gsub(/(\r\n?|\n)/, "\\r\\n").fold!(75,12) %><%= "\r\n"
%><% end
%>CLASS:PUBLIC<%= "\r\n"
%>URL:<%= event_url(event).fold!(75,4) %><%= "\r\n"
%><% if event.location? || event.address?
  # TODO: handle city, province, country, location_url.
  location = event.location + (event.address? ? " (#{event.address})" : '')
  %>LOCATION:<%= location.fold!(75,9) %><%= "\r\n"
%><% end
%>STATUS:<%
if event.is_tentative? || !(event.is_approved?)
  %>TENTATIVE<%
elsif event.is_cancelled?
  %>CANCELLED<%
else
  %>CONFIRMED<%
end %><%= "\r\n"
%><%
if event.organizer?
  if event.organizer_url?
    organizer = ";CN=#{event.organizer}:#{event.organizer_url}"
  else
    organizer = ":CN=#{event.organizer}"
  end
  %>ORGANIZER<%= organizer.fold!(75,9) %><%= "\r\n"
%><%
elsif event.organizer_url?
  %>ORGANIZER:<%= event.organizer_url.fold!(75,10) %><%= "\r\n"
%><%
end

#if event.external_links.count > 0
#  event.external_links.each do |el|
#    nil
#    % >ATTACH:< %= el.url.fold!(75,7) % >
#< %
#  end
#end
%>SEQUENCE:<%= event.versions.count %><%= "\r\n"
%><%

# TODO: more icalendar fields
#
#CATEGORIES: = event.tags.join(',').upcase.fold!(75,11)

%>END:VEVENT<%= "\r\n"
%>