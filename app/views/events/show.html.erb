<% # encoding: utf-8
require 'event_presenter'

event ||= @event
@versioned_item = event # let the application template know we’re looking at an item with versions
set_main_section_class 'vevent'

presenter = EventPresenter.new(view: self, event: event, user: @user)

content_for(:head) do
  %><link rel="alternate" href="<%= event_path(event, format: 'ics') %>" type="text/calendar" title="icalendar file for event" />
<link rel="profile" href="http://microformats.org/profile/hcalendar" />
<%
end

attrs = presenter.event_heading_attrs
attrs[:class] ||= []
attrs[:class] << 'summary'
%><%= presenter.html_tag(:h2, attrs) { presenter.present_status + event.title } %>

<p><%= presenter.present_schedule_with_date %>
<br /><%= link_to 'Download to your calendar.', event_path(event, format: 'ics'), class: 'ics', title: "Download this event as a file compatible with most calendar applications" %></p>

<%= presenter.present_location_block %>
<%
organizer = presenter.present_organizer
if organizer.present?
  %><p><%= organizer %></p>

<%
end

if event.description?
  %><%= simple_text_to_html(event.description) %>

<%
end

if event.content?
  %><%= simple_text_to_html(event.content) %>

<%
end


if event.external_links.count > 0
  content_for(:other_sections) do
    %>
<section class="external_links"><h3>Links for this event</h3>
<ul>
<%
  event.external_links.each do |external_link|
    %><%= render 'external_links/external_link', {user: @user, item: event, external_link: external_link} %><%
  end
%></ul>
</section>
<%
  end
end


if @user.present?
  %><p class="actions"><%
  if event.has_authority_for_user_to?(@user, :can_update)
    %><%= link_to 'Edit', edit_event_path(event), class: 'action' %><%= separator %>
<%
  end
  if !(event.is_approved?) && event.has_authority_for_user_to?(@user, :can_approve)
    %><%= link_to 'Approve', approve_event_path(event), data: {confirm: "Are you sure you want to approve the event “#{event.title}”?"}, method: :post, class: 'action' %><%= separator %>
<%
  end
  if event.has_authority_for_user_to?(@user, :can_delete)
    if event.has_authority_for_user_to?(@user, :can_update)
      %><%= link_to 'Merge', merge_event_path(event), class: 'action', title: 'Merge with another Event (you must know the event id)' %><%= separator %>
<%
    end
    %><%= link_to 'Delete', [:delete, event], data: {confirm: 'Are you sure?'}, method: :delete, class: 'action' %><%= separator %>
<%
  end
  if event.has_authority_for_user_to?(@user, :can_create)
    %><%= link_to 'New External Link', new_event_external_link_path(event), class: 'action' %><%= separator %>
<%
  end
  %><%= link_to 'New Event', new_event_path, class: 'action' %></p>
<%
end -%>
